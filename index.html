<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PMS Strategic Map</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Google Font: Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Phosphor Icons (Lightweight icon library) -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
            overflow: hidden; /* Prevent body scroll to handle zoom/pan nicely */
        }
        
        /* Smooth scrolling for the modal content */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f5f9; 
            border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #cbd5e1; 
            border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #94a3b8; 
        }

        /* Animations */
        @keyframes pulse-border {
            0% { box-shadow: 0 0 0 0 rgba(245, 158, 11, 0.4); }
            70% { box-shadow: 0 0 0 6px rgba(245, 158, 11, 0); }
            100% { box-shadow: 0 0 0 0 rgba(245, 158, 11, 0); }
        }
        .dependency-pulse {
            animation: pulse-border 2s infinite;
        }

        /* Soft, dynamic highlighting for related departments */
        .dept-glow {
            position: relative;
            overflow: hidden;
        }
        .dept-glow::before {
            content: "";
            position: absolute;
            inset: -40%;
            background:
                radial-gradient(circle at 30% 30%, rgba(125, 211, 252, 0.35), transparent 60%),
                radial-gradient(circle at 70% 60%, rgba(167, 139, 250, 0.25), transparent 55%),
                radial-gradient(circle at 40% 80%, rgba(134, 239, 172, 0.18), transparent 60%);
            filter: blur(14px);
            animation: auroraMove 4s ease-in-out infinite;
            pointer-events: none;
            z-index: 0;
        }
        .dept-glow::after {
            content: "";
            position: absolute;
            inset: 0;
            background: linear-gradient(180deg, rgba(255,255,255,0.45), rgba(255,255,255,0));
            pointer-events: none;
            z-index: 0;
        }
        .dept-glow > * {
            position: relative;
            z-index: 1;
        }
        @keyframes auroraMove {
            0%   { transform: translate(-6%, -4%) scale(1); }
            50%  { transform: translate(6%, 4%) scale(1.06); }
            100% { transform: translate(-6%, -4%) scale(1); }
        }

        /* KPI popup animation */
        .kpi-pop {
            animation: popCenter 0.22s ease-out forwards;
        }
        .dept-pop { animation: popCenter 0.22s ease-out forwards; }
        @keyframes popCenter {
            from { opacity: 0; transform: translateY(10px) scale(0.97); }
            to   { opacity: 1; transform: translateY(0) scale(1); }
        }

        .fade-in {
            animation: fadeIn 0.3s ease-out forwards;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    
        /* --- Related departments badges (color-coded) --- */
        .dept-badges{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
        .dept-badge{
        display:inline-flex;align-items:center;justify-content:center;
        padding:6px 10px;border-radius:999px;
        font-size:12px;font-weight:700;line-height:1;
        color:#fff;box-shadow:0 6px 16px rgba(0,0,0,.12);
        transform:translateZ(0);
        }
        .dept-badge.small{padding:5px 9px;font-size:11px}
        .dept-operations{background:linear-gradient(135deg,#007f99,#00a7c4)}
        .dept-finance{background:linear-gradient(135deg,#1a5fb4,#3b82f6)}
        .dept-commercial{background:linear-gradient(135deg,#4f46e5,#7c3aed)}
        .dept-plant{background:linear-gradient(135deg,#ff7a00,#ffb000)}
        .dept-qhse{background:linear-gradient(135deg,#c1121f,#ff3b30)}
        .dept-hr{background:linear-gradient(135deg,#0f766e,#14b8a6)}
        .dept-diving{background:linear-gradient(135deg,#006d77,#00b4d8)}
        .dept-it{background:linear-gradient(135deg,#1f2937,#111827)}
        .dept-ceo{background:linear-gradient(135deg,#111827,#334155)}
        .dept-coo{background:linear-gradient(135deg,#0b1320,#1f3a8a)}

    </style>
</head>
<body class="text-slate-800">

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- dept badge helper (color-coded) ---
        const deptToClass = (name) => {
            const n = (name || "").toString().trim().toLowerCase();
            const slug = n.replace(/[^a-z0-9]+/g, "-").replace(/^-+|-+$/g, "");
            const map = {
                "qhse": "qhse", "q-hse": "qhse", "hse": "qhse",
                "plant": "plant", "assets": "plant", "asset": "plant",
                "operations": "operations", "ops": "operations",
                "finance": "finance",
                "commercial": "commercial", "sales": "commercial",
                "hr": "hr", "human-resources": "hr",
                "diving": "diving",
                "it": "it", "ict": "it",
                "ceo": "ceo",
                "coo": "coo"
            };
            return map[slug] || slug;
        };

        // --- ICONS (Using SVG wrappers) ---
        const IconWrapper = ({ children, size = 16, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{children}</svg>
        );

        const Icons = {
            Briefcase: (props) => <IconWrapper {...props}><rect width="20" height="14" x="2" y="7" rx="2" ry="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/></IconWrapper>,
            Activity: (props) => <IconWrapper {...props}><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></IconWrapper>,
            DollarSign: (props) => <IconWrapper {...props}><line x1="12" x2="12" y1="2" y2="22"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></IconWrapper>,
            UserCheck: (props) => <IconWrapper {...props}><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><polyline points="16 11 18 13 22 9"/></IconWrapper>,
            Layers: (props) => <IconWrapper {...props}><polygon points="12 2 2 7 12 12 22 7 12 2"/><polyline points="2 17 12 22 22 17"/><polyline points="2 12 12 17 22 12"/></IconWrapper>,
            Anchor: (props) => <IconWrapper {...props}><circle cx="12" cy="5" r="3"/><line x1="12" x2="12" y1="22" y2="8"/><path d="M5 12H2a10 10 0 0 0 20 0h-3"/></IconWrapper>,
            HardHat: (props) => <IconWrapper {...props}><path d="M2 18a1 1 0 0 0 1 1h18a1 1 0 0 0 1-1v-2a1 1 0 0 0-1-1H3a1 1 0 0 0-1 1v2z"/><path d="M10 10V5a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v5"/><path d="M4 15v-3a6 6 0 0 1 6-6h0"/><path d="M14 6h0a6 6 0 0 1 6 6v3"/></IconWrapper>,
            FileText: (props) => <IconWrapper {...props}><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z"/><path d="M14 2v4a2 2 0 0 0 2 2h4"/><path d="M10 9H8"/><path d="M16 13H8"/><path d="M16 17H8"/></IconWrapper>,
            Shield: (props) => <IconWrapper {...props}><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></IconWrapper>,
            Sparkles: (props) => <IconWrapper {...props}><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L12 21l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/><path d="M5 3v4"/><path d="M9 3v4"/><path d="M3 5h4"/><path d="M3 9h4"/></IconWrapper>,
            X: (props) => <IconWrapper {...props}><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></IconWrapper>,
            Loader: (props) => <IconWrapper {...props} className={`${props.className} animate-spin`}><path d="M21 12a9 9 0 1 1-6.219-8.56"/></IconWrapper>,
            Link: (props) => <IconWrapper {...props}><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></IconWrapper>,
            Gear: (props) => <IconWrapper {...props}><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></IconWrapper>,
            Building2: (props) => <IconWrapper {...props}><path d="M6 22V4a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v18Z" /><path d="M6 12H4a2 2 0 0 0-2 2v6a2 2 0 0 0 2 2h2" /><path d="M18 9h2a2 2 0 0 1 2 2v9a2 2 0 0 1-2 2h-2" /><path d="M10 6h4" /><path d="M10 10h4" /><path d="M10 14h4" /><path d="M10 18h4" /></IconWrapper>,
            Question: (props) => <IconWrapper {...props}><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><line x1="12" y1="17" x2="12.01" y2="17"/></IconWrapper>,
            CaretDown: (props) => <IconWrapper {...props}><polyline points="6 9 12 15 18 9"/></IconWrapper>
        };

        // --- THEME DEFINITIONS ---
        const deptThemes = {
            Finance:    { bg: 'bg-blue-100',    text: 'text-blue-800',    border: 'border-blue-200',    solid: 'bg-blue-600',    badgeText: 'text-white' },
            QHSE:       { bg: 'bg-red-100',     text: 'text-red-800',     border: 'border-red-200',     solid: 'bg-red-600',     badgeText: 'text-white' },
            Operations: { bg: 'bg-cyan-100',    text: 'text-cyan-800',    border: 'border-cyan-200',    solid: 'bg-cyan-600',    badgeText: 'text-white' },
            Commercial: { bg: 'bg-indigo-100',  text: 'text-indigo-800',  border: 'border-indigo-200',  solid: 'bg-indigo-600',  badgeText: 'text-white' },
            Plant:      { bg: 'bg-orange-100',  text: 'text-orange-800',  border: 'border-orange-200',  solid: 'bg-orange-600',  badgeText: 'text-white' },
            HR:         { bg: 'bg-purple-100',  text: 'text-purple-800',  border: 'border-purple-200',  solid: 'bg-purple-600',  badgeText: 'text-white' },
            Diving:     { bg: 'bg-teal-100',    text: 'text-teal-800',    border: 'border-teal-200',    solid: 'bg-teal-600',    badgeText: 'text-white' },
            COO:        { bg: 'bg-emerald-100', text: 'text-emerald-800', border: 'border-emerald-200', solid: 'bg-emerald-700', badgeText: 'text-white' },
            CEO:        { bg: 'bg-slate-100',   text: 'text-slate-800',   border: 'border-slate-200',   solid: 'bg-slate-800',   badgeText: 'text-white' },
            IT:         { bg: 'bg-sky-100',     text: 'text-sky-800',     border: 'border-sky-200',     solid: 'bg-sky-600',     badgeText: 'text-white' },
        };
        const defaultTheme = { bg: 'bg-gray-100', text: 'text-gray-800', border: 'border-gray-200', solid: 'bg-gray-500', badgeText: 'text-white' };

        // --- COMPONENTS ---

        const KPICard = ({ title, target, type, affectedByDept, functions, relatedDepts = [], onSelect, onHover, onLeave }) => {
            let styleClass = "";
            if (affectedByDept && deptThemes[affectedByDept]) {
                const theme = deptThemes[affectedByDept];
                styleClass = `${theme.bg} ${theme.text} border-l-4 ${theme.border.replace('border', 'border-l')}`;
            } else {
                 switch (type) {
                    case 'Financial': styleClass = 'bg-blue-50 text-blue-700 border-blue-100'; break;
                    case 'Safety': styleClass = 'bg-red-50 text-red-700 border-red-100'; break;
                    case 'Operational': styleClass = 'bg-green-50 text-green-700 border-green-100'; break;
                    case 'Asset': styleClass = 'bg-orange-50 text-orange-700 border-orange-100'; break;
                    case 'HR': styleClass = 'bg-purple-50 text-purple-700 border-purple-100'; break;
                    case 'Growth': styleClass = 'bg-indigo-50 text-indigo-700 border-indigo-100'; break;
                    case 'Strategic': styleClass = 'bg-slate-50 text-slate-700 border-slate-100'; break;
                    case 'Governance': styleClass = 'bg-gray-50 text-gray-700 border-gray-100'; break;
                    case 'Technology': styleClass = 'bg-sky-50 text-sky-700 border-sky-100'; break;
                    default: styleClass = 'bg-gray-50 text-gray-700 border-gray-100'; break;
                }
            }

            return (
                <div
                    role="button"
                    tabIndex={0}
                    onClick={(e) => { e.stopPropagation(); onSelect && onSelect({ title, target, type, functions, relatedDepts }); }}
                    onKeyDown={(e) => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); e.stopPropagation(); onSelect && onSelect({ title, target, type, functions, relatedDepts }); } }}
                    onMouseEnter={() => onHover && onHover(relatedDepts)}
                    onMouseLeave={() => onLeave && onLeave()}
                    className={`px-2.5 py-2 mb-1.5 rounded-lg border text-[11px] ${styleClass} transition-all duration-300 shadow-sm cursor-pointer hover:shadow-md hover:-translate-y-[1px] focus:outline-none focus:ring-2 focus:ring-indigo-400`}>

                    <div className="flex justify-between items-center">
                        <span className="font-semibold truncate pr-2 w-2/3" title={title}>{title}</span>
                        <span className="whitespace-nowrap opacity-90 font-bold bg-white/50 px-1.5 py-0.5 rounded text-[10px]">{target}</span>
                    </div>
                    {functions && (
                        <div className="mt-1.5 pt-1.5 border-t border-black/5 text-[9px] opacity-80 leading-tight flex flex-col gap-0.5">
                            <div><span className="font-semibold">Fn:</span> {functions}</div>
                        </div>
                    )}
                </div>
            );
        };

        const OrgNode = ({ id, title, roleFocus, icon: Icon, kpis, colorClass, onAnalyze, width = "w-72", onHover, hoveredId, dependencies = [], affectedBy = [], highlightDepts = [], onKpiSelect, onKpiHover, onKpiLeave, onDeptSelect, hideKpis = false }) => {
            const isHovered = hoveredId === id;
            const isAffected = hoveredId && affectedBy.includes(hoveredId);
            const isEffector = hoveredId && dependencies.includes(hoveredId);
            const isHighlighted = highlightDepts && highlightDepts.includes(id);
            
            let containerStyle = `flex flex-col ${width} bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden relative group transition-all duration-300 cursor-pointer select-none`;
            
            if (isHovered) {
                containerStyle += " ring-2 ring-indigo-500 transform -translate-y-1 shadow-xl z-20";
            } else if (isAffected) {
                containerStyle += " ring-2 ring-amber-400 dependency-pulse z-10 scale-[1.02]";
            } else if (isHighlighted) {
                containerStyle += " ring-2 ring-sky-300 dept-glow z-30 scale-[1.03]";
            } else if (hoveredId && !isAffected && !isEffector && !isHighlighted) {
                containerStyle += " opacity-30 grayscale";
            }

            return (
                <div 
                    className={containerStyle}
                    onMouseEnter={() => onHover(id)}
                    onMouseLeave={() => onHover(null)}
                    onClick={() => onDeptSelect && onDeptSelect({ id, title, roleFocus, colorClass, icon: Icon, kpis })}
                    role="button"
                    tabIndex={0}
                    onKeyDown={(e) => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); onDeptSelect && onDeptSelect({ id, title, roleFocus, colorClass, icon: Icon, kpis }); } }}
                >
                    {/* Header */}
                    <div className={`p-3 ${colorClass} text-white relative`}>
                        <div className="flex items-center gap-2 mb-1">
                            <div className="p-1.5 bg-white/20 rounded-lg backdrop-blur-sm">
                                <Icon size={18} />
                            </div>
                            <h3 className="font-bold text-sm leading-tight">{title}</h3>
                        </div>
                        <p className="text-[10px] opacity-90 font-medium uppercase tracking-wide">{roleFocus}</p>
                        
                        {isAffected && (
                            <div className="absolute top-2 right-12 bg-amber-400 text-amber-900 text-[9px] font-bold px-1.5 py-0.5 rounded shadow flex items-center gap-1 animate-pulse">
                                <Icons.Link size={10} /> DEPENDS
                            </div>
                        )}

                        <button 
                            onClick={(e) => { e.stopPropagation(); onAnalyze(title, kpis, roleFocus); }}
                            className="absolute top-2 right-2 bg-white/20 hover:bg-white/40 text-white p-1.5 rounded-full transition-all backdrop-blur-sm opacity-90 hover:opacity-100 hover:scale-110"
                            title="Analyze with AI"
                        >
                            <Icons.Sparkles size={14} />
                        </button>
                    </div>

                    {/* Body - Conditionally Rendered */}
                    {!hideKpis && (
                        <div className="p-2 space-y-1 bg-slate-50 flex-grow"
                            title="Click to focus this department table">
                            {kpis.map((kpi, idx) => (
                                <KPICard key={idx} {...kpi} onSelect={onKpiSelect} onHover={onKpiHover} onLeave={onKpiLeave} />
                            ))}
                        </div>
                    )}
                    
                    {/* Visual spacer if KPIs hidden to separate header and footer slightly */}
                    {hideKpis && <div className="h-1 bg-slate-50"></div>}

                    {/* Related Departments */}
                    {(() => {
                        const rel = Array.from(new Set((kpis || []).flatMap(k => (k.relatedDepts || [])))).filter(Boolean);
                        if (!rel.length) return null;
                        return (
                            <div className="px-3 py-2 border-t border-slate-100 bg-white/70">
                                <div className="text-[10px] font-semibold text-slate-500 uppercase tracking-wide mb-1">Related / Affected Departments</div>
                                <div className="dept-badges">
                                    {rel.map((d) => (
                                        <span key={d} className={`dept-badge small dept-${deptToClass(d)}`}>{d}</span>
                                    ))}
                                </div>
                            </div>
                        );
                    })()}

                </div>
            );
        };

        const AIModal = ({ isOpen, onClose, title, content, isLoading, error, onSaveKey }) => {
            if (!isOpen) return null;
            const isKeyError = error && error.includes("API Key");
            return (
                <div className="fixed inset-0 bg-slate-900/60 z-50 flex items-center justify-center p-4 backdrop-blur-sm">
                    <div className="bg-white rounded-2xl shadow-2xl w-full max-w-2xl max-h-[85vh] flex flex-col fade-in">
                        <div className="p-5 border-b border-slate-100 flex justify-between items-center bg-gradient-to-r from-slate-50 to-white rounded-t-2xl">
                            <div className="flex items-center gap-3">
                                <div className="p-2 bg-indigo-100 rounded-lg text-indigo-600">
                                    <Icons.Sparkles size={20} />
                                </div>
                                <div>
                                    <h3 className="font-bold text-lg text-slate-800">Gemini Strategy Engine</h3>
                                    <p className="text-xs text-slate-500">{title}</p>
                                </div>
                            </div>
                            <button onClick={onClose} className="p-2 hover:bg-slate-100 rounded-full text-slate-400 transition-colors">
                                <Icons.X size={20} />
                            </button>
                        </div>
                        <div className="p-6 overflow-y-auto text-sm text-slate-600 leading-relaxed custom-scrollbar">
                            {isLoading ? (
                                <div className="flex flex-col items-center justify-center py-12 space-y-4">
                                    <Icons.Loader className="text-indigo-600" size={32} />
                                    <p className="text-xs text-slate-400 font-semibold animate-pulse tracking-widest uppercase">Analyzing Data Pattern...</p>
                                </div>
                            ) : error ? (
                                <div className="bg-red-50 text-red-800 p-4 rounded-lg border border-red-100">
                                    <p className="font-bold flex items-center gap-2 mb-2"><Icons.Shield size={16}/> {isKeyError ? "Setup Required" : "Analysis Failed"}</p>
                                    <p>{error}</p>
                                    {isKeyError && (
                                        <div className="mt-4">
                                            <input type="text" placeholder="Enter Gemini API Key..." className="w-full p-2 border border-slate-300 rounded text-sm mb-2" onKeyDown={(e) => { if(e.key === 'Enter') onSaveKey(e.target.value); }} />
                                            <button className="bg-indigo-600 text-white px-4 py-2 rounded text-sm font-medium hover:bg-indigo-700" onClick={(e) => onSaveKey(e.previousElementSibling.value)}>Save Key & Retry</button>
                                        </div>
                                    )}
                                </div>
                            ) : (
                                <div className="prose prose-sm max-w-none prose-headings:text-slate-800 prose-p:text-slate-600 prose-li:text-slate-600"><div dangerouslySetInnerHTML={{ __html: content }} /></div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        const SettingsModal = ({ isOpen, onClose, currentKey, onSave }) => {
            if (!isOpen) return null;
            const [val, setVal] = useState(currentKey);
            return (
                 <div className="fixed inset-0 bg-slate-900/60 z-50 flex items-center justify-center p-4 backdrop-blur-sm">
                    <div className="bg-white rounded-xl shadow-xl w-full max-w-md p-6 fade-in">
                        <h3 className="text-lg font-bold mb-4">Settings</h3>
                        <label className="block text-sm font-medium text-slate-700 mb-2">Gemini API Key</label>
                        <input type="password" value={val} onChange={(e) => setVal(e.target.value)} placeholder="AIza..." className="w-full p-2 border border-slate-300 rounded mb-4 focus:ring-2 focus:ring-indigo-500 outline-none" />
                        <div className="flex justify-end gap-2">
                            <button onClick={onClose} className="px-4 py-2 text-slate-600 hover:bg-slate-100 rounded">Cancel</button>
                            <button onClick={() => { onSave(val); onClose(); }} className="px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700">Save</button>
                        </div>
                    </div>
                </div>
            );
        };

        // --- MAIN APP ---
        

        // --- Master Target Logic Map (Why this target?) ---
        // Fallback if KPI doesn't have targetExplanation in its object.
        const TARGET_LOGIC_MAP = {
            // CEO
            "Revenue Growth": "Ensures sustainable growth without overstretching assets or people. Too low = stagnation, too high = uncontrolled risk.",
            "Client Retention": "In marine/diving, repeat clients mean trust. Losing repeat work is an early sign of quality or relationship failure.",
            "Major Client Approval": "Access to ADNOC / Tier-1 clients is strategic, not volume-based. Even one approval changes company positioning.",
            "Zero Major Incidents": "One fatal or major incident can shut down operations, damage reputation, and block future contracts.",
            "Cash Stability": "Survival KPI. Even profitable companies fail if cash is negative.",
            "International Industry Participation": "Ensures visibility, credibility, and future market access beyond local dependency.",
            "Strategic International Partnerships": "Ensures visibility, credibility, and future market access beyond local dependency.",
            "Thought Leadership & Knowledge Contribution": "Builds credibility and sector authority.",

            // COO
            "On-Time Project Delivery": "Some delay is realistic offshore, but <90% indicates planning or control failure.",
            "Project Margin Protection": "Winning projects is useless if margin erodes during execution. COO protects profit.",
            "Equipment Readiness": "One missing asset can stop the job. 100% is ideal, 95% is realistic with backups.",
            "Offshore Incidents": "COO owns day-to-day safety execution, not just policy.",
            "Client Complaints": "Complaints are early warnings of future claims or lost clients.",
            "Digital Asset & Certification Visibility": "No visibility = no control. Missing one certificate can stop an entire project.",
            "Technology Deployment & Automation Index": "Prevents stagnation and reduces manual, error-prone processes through controlled tech rollout.",
            "Process Optimization Initiatives": "Prevents stagnation and reduces manual, error-prone processes by removing waste and reducing errors.",

            // Operations
            "Mobilization Readiness": "Any missing document, crew, or asset on Day 1 causes immediate delay and cost.",
            "Daily Plan Achievement": "Offshore work is dynamic; 100% is unrealistic. Below 85% shows weak planning or discipline.",
            "PMS-Caused Delays": "Internal delays are fully controllable and directly reduce profit.",
            "Cost Variance": "Small variance is acceptable; above this signals loss of control.",
            "Major NCRs": "Major non-conformances can stop work and damage client trust.",

            // Diving
            "Incident-Free Dive Hours": "Diving has zero tolerance for accidents; one failure can be fatal.",
            "Dive Plan Compliance": "Minor justified deviations happen, but frequent deviations mean loss of control.",
            "Equipment Condition": "Equipment failure underwater is life-critical.",
            "CMS Compliance": "Uncertified divers = illegal, unsafe, and non-compliant with IMCA.",
            "Rework / NCRs": "Rework in diving means poor planning or unsafe execution.",

            // Commercial
            "Tender Win Rate": "Below this means poor bid selection or pricing; higher can mean underpricing.",
            "Tender Compliance": "One missing document = automatic rejection.",
            "Backlog Coverage": "Ensures stable workload and avoids panic bidding or idle assets.",
            "Pricing Accuracy": "Winning with wrong pricing destroys margin after award.",
            "Client Follow-up": "Feedback improves future bids and relationships.",
            "International Market Penetration": "Reduces dependency on one market and spreads risk.",
            "Market Survey": "Understanding client behavior helps choose the right tenders and price correctly.",

            // Finance
            "Cash Flow": "Cash pays salaries, fuel, suppliers—profit alone does not.",
            "DSO": "Late payments increase financial risk and operational pressure. Target keeps collections within a controllable window.",
            "Cost Control": "Small overruns are normal; large ones silently destroy profit.",
            "Payroll Timeliness": "Late salaries cause morale loss and operational instability.",
            "Audit Readiness": "Audit failure damages trust, certifications, and client confidence.",

            // HR
            "Staff Turnover": "High turnover causes loss of competence and project delays.",
            "Certification Validity": "Expired certificates can stop work and fail audits instantly.",
            "Crew Availability": "Lack of crew delays mobilization and breaks commitments.",
            "Training Completion": "Training improves safety, quality, and long-term capability.",
            "Discipline Issues": "Poor discipline leads to accidents and reputation damage.",

            // Plant
            "Equipment Availability": "One missing critical asset can stop the job entirely.",
            "Certification Validity (Plant)": "Uncertified equipment cannot be used, even if functional.",
            "Breakdown Incidents": "Breakdowns cause delays, safety risks, and extra cost.",
            "Damage Rate": "Damage shortens asset life and increases cost.",
            "Utilization Rate": "Too low = wasted capital, too high = accelerated failure.",
            "Preventive Maintenance Digitalization": "Automation keeps preventive maintenance on-time, reducing breakdown risk and manual errors.",

            // QHSE
            "TRIR": "Injuries indicate system failure and weak enforcement. Target is zero to reinforce zero harm culture.",
            "Near Miss Reporting": "More reports = better safety awareness and earlier risk detection (leading indicator).",
            "Stop Work Actions": "Stopping unsafe work saves lives; the target prevents under-reporting or pressure to continue.",
            "Audit Findings Closed": "Open findings mean the IMS is ineffective. 100% closure keeps compliance audit-ready.",
            "Environmental Incidents": "Environmental damage causes fines, work stoppage, and reputation loss—target is zero."
        };

        const normalizeKey = (s) => (s || "").toString().trim().toLowerCase();

        const getTargetLogic = (kpi) => {
            if (!kpi) return "";
            // 1) Use KPI's own explanation if present
            if (kpi.targetExplanation) return kpi.targetExplanation;

            // 2) Exact title match
            if (TARGET_LOGIC_MAP[kpi.title]) return TARGET_LOGIC_MAP[kpi.title];

            // 3) Case-insensitive match
            const want = normalizeKey(kpi.title);
            const hit = Object.keys(TARGET_LOGIC_MAP).find(k => normalizeKey(k) === want);
            return hit ? TARGET_LOGIC_MAP[hit] : "";
        };

        // Heuristic fallback: always return a brief, reasonable explanation based on what we've discussed:
        // - Safety/compliance = zero-tolerance where failure stops work or harms people
        // - Operational = delivery discipline (mobilization, plan achievement, delay control)
        // - Financial = survival (cash, margin, cost control)
        // - Asset = readiness, uptime, certification
        // - HR = competence + availability
        const autoExplainTarget = (kpi) => {
            if (!kpi) return "This target is set to keep performance controlled, auditable, and aligned with operational risk.";
            const title = (kpi.title || "").toString().trim();
            const cat = (kpi.category || "").toString().trim().toLowerCase();
            const tgt = (kpi.target || "").toString().trim();

            const t = title.toLowerCase();
            const v = tgt.toLowerCase();

            // Quick target-type cues
            if (v.includes("zero")) {
                // Zero is used where one failure has outsized consequences.
                if (cat.includes("safety") || t.includes("incident") || t.includes("injur") || t.includes("trir")) {
                    return "Zero is required because even one incident can injure people, stop work, and damage reputation. This is a zero‑tolerance safety control.";
                }
                if (t.includes("ncr") || t.includes("non") || t.includes("audit") || cat.includes("compliance") || cat.includes("quality")) {
                    return "Zero is required because major non‑conformance triggers audits, stoppage, or penalties. This is a compliance gate, not a performance preference.";
                }
                if (t.includes("delay")) {
                    return "Zero is required because internal delays are controllable and directly destroy margin. This forces discipline and fast cross‑department coordination.";
                }
                return "Zero is required because any failure here has immediate operational or reputational impact. It is set as a strict control target.";
            }

            if (v.includes("positive")) {
                return "This target is set to protect company survival: cash must stay positive to pay salaries, suppliers, and keep operations running even during delays.";
            }

            if (v.includes("day") && (v.includes("<") || v.includes("less"))) {
                return "This target is set to reduce cash pressure: faster collection keeps payroll and suppliers stable and prevents operational disruption.";
            }

            // Percent cues (very light parsing)
            const pctMatch = tgt.match(/(\d+)\s*%/);
            const pct = pctMatch ? parseInt(pctMatch[1], 10) : null;

            // Common KPI intents
            if (t.includes("retention") || t.includes("repeat")) {
                return "This target is set high because repeat clients mean trust and lower acquisition risk. A drop is an early warning of relationship or delivery issues.";
            }
            if (t.includes("delivery") || t.includes("on-time")) {
                return "This target is set to enforce delivery reliability. Offshore variability exists, but consistent on‑time delivery is required to protect client confidence and margin.";
            }
            if (t.includes("readiness") || t.includes("availability") || t.includes("uptime")) {
                return "This target is set high because one missing person or asset can stop a job. Readiness protects schedule, margin, and client commitments.";
            }
            if (t.includes("certificate") || t.includes("certification") || t.includes("compliance") || t.includes("audit")) {
                return "This target is strict because certification and audit readiness are pass/fail. Missing one document can fail audits or block equipment/personnel from working.";
            }
            if (t.includes("margin") || t.includes("pricing") || t.includes("cost")) {
                return "This target is set to protect profit. Small variance is acceptable; large variance signals loss of control and quietly destroys project margin.";
            }
            if (t.includes("utilization")) {
                return "This target is balanced to protect ROI without overloading assets: too low wastes capital, too high accelerates failure and downtime.";
            }
            if (t.includes("training") || t.includes("competence") || t.includes("cms")) {
                return "This target is set high because competence is a safety and compliance requirement. Training and certification gaps create audit failures and operational risk.";
            }

            // Category-based fallback
            if (cat.includes("safety")) return "This target is set to prevent harm and protect operational license-to-operate. Safety KPIs are treated as control limits, not negotiable goals.";
            if (cat.includes("financial")) return "This target is set to protect cash and margin. Financial KPIs ensure the business remains stable and audit-ready.";
            if (cat.includes("operational")) return "This target is set to enforce execution discipline and reduce controllable delays that cascade into cost overruns.";
            if (cat.includes("asset") || cat.includes("plant")) return "This target is set to keep equipment ready, certified, and reliable so projects start and run without stoppage.";
            if (cat.includes("hr") || cat.includes("human")) return "This target is set to ensure people readiness (availability, competence, and stability) so mobilization is not delayed.";
            if (cat.includes("commercial") || cat.includes("growth")) return "This target is set to drive controlled growth: win the right work, at the right price, with the right risk.";
            if (cat.includes("strategic")) return "This target is set to strengthen positioning, risk ownership, and long-term sustainability beyond short-term operations.";

            // Percent general fallback
            if (pct !== null) {
                if (pct >= 95) return "This target is set high because performance here must be near-perfect to avoid stoppage, non-compliance, or major operational disruption.";
                if (pct >= 80) return "This target is set to ensure consistent performance and early warning when control weakens.";
                if (pct >= 60) return "This target is set to maintain acceptable control while accounting for offshore variability.";
            }

            return "This target is set to keep performance measurable, controlled, and aligned with risk (safety, margin, delivery, and audit readiness).";
        };


        const KPIModal = ({ isOpen, onClose, data }) => {
            if (!isOpen || !data) return null;
            const { kpi, origin } = data;
            const [showTargetExpl, setShowTargetExpl] = useState(false);
            const targetLogic = getTargetLogic(kpi) || autoExplainTarget(kpi);
            const rel = (kpi && kpi.relatedDepts) ? kpi.relatedDepts : [];

            // Simple logic to provide a generic explanation if specific one isn't found
            const getRelationText = (dept) => {
                if (kpi.relationDetails && kpi.relationDetails[dept]) return kpi.relationDetails[dept];
                // Fallback generic text
                if (dept === 'Finance') return 'Impacts budget, cash flow, or cost control.';
                if (dept === 'Operations') return 'Directly affects project execution, schedule, or margin.';
                if (dept === 'Commercial') return 'Affects ability to win tenders or client relationship.';
                if (dept === 'QHSE') return 'Impacts safety compliance, audits, or license to operate.';
                if (dept === 'Plant') return 'Depends on equipment readiness or certification.';
                if (dept === 'HR') return 'Requires competent personnel or affects crew availability.';
                return 'Strategic dependency or downstream impact.';
            };

            return (
                <div className="fixed inset-0 bg-slate-900/55 z-[60] flex items-center justify-center p-4 backdrop-blur-sm" onClick={onClose}>
                    <div className="bg-white rounded-2xl shadow-2xl w-full max-w-xl kpi-pop border border-slate-200 overflow-hidden flex flex-col max-h-[90vh]" onClick={(e) => e.stopPropagation()}>
                        <div className="p-5 border-b border-slate-100 flex items-start justify-between bg-gradient-to-r from-slate-50 to-white shrink-0">
                            <div className="min-w-0 pr-4">
                                <div className="text-[11px] text-slate-500 font-semibold uppercase tracking-wide">Focused KPI</div>
                                <div className="text-lg font-bold text-slate-900 leading-snug mt-1">{kpi?.title}</div>
                                <div className="text-xs text-slate-500 mt-1">Source: <span className="font-semibold text-slate-700">{origin}</span></div>
                            </div>
                            <button onClick={onClose} className="p-2 hover:bg-slate-100 rounded-full transition-colors" title="Close">
                                <Icons.X size={18} />
                            </button>
                        </div>

                        <div className="p-5 space-y-5 overflow-y-auto custom-scrollbar flex-grow">
                            
                            <div className="flex gap-4">
                                <div className="flex-1">
                                    <div className="text-xs font-semibold text-slate-600 mb-1">Type</div>
                                    <div className="px-2.5 py-1 rounded-full bg-slate-100 text-slate-700 text-xs font-bold inline-block border border-slate-200">{kpi?.type || "—"}</div>
                                </div>
                                <div className="flex-1 relative">
                                    <div className="text-xs font-semibold text-slate-600 mb-1 flex items-center gap-1">
                                        Target 
                                        <button 
                                            onClick={(e) => { e.stopPropagation(); setShowTargetExpl(!showTargetExpl); }} 
                                            className={`focus:outline-none transition-colors ${showTargetExpl ? 'text-indigo-700' : 'text-indigo-500 hover:text-indigo-700'}`} 
                                            title="Why this target?"
                                        >
                                            <Icons.Question size={14} weight="bold" />
                                        </button>
                                    </div>
                                    <div 
                                        className="text-lg font-extrabold text-slate-900 cursor-pointer hover:text-indigo-600 transition-colors flex items-center gap-2"
                                        onClick={(e) => { e.stopPropagation(); setShowTargetExpl(!showTargetExpl); }}
                                    >
                                        {kpi?.target || "—"}
                                        {!!targetLogic && (
                                            <Icons.CaretDown 
                                                size={12} 
                                                weight="bold" 
                                                className={`text-slate-400 transition-transform duration-200 ${showTargetExpl ? 'rotate-180' : ''}`}
                                            />
                                        )}
                                    </div>
                                    
                                    {/* Inline Expandable Explanation (Fixed clipping issue) */}
                                    {showTargetExpl && (
                                        <div className="mt-2 p-3 bg-slate-800 text-white text-xs rounded-lg shadow-inner animate-in fade-in slide-in-from-top-1 duration-200">
                                            <div className="font-bold mb-1 text-slate-300 uppercase tracking-wide text-[10px] flex items-center gap-1">
                                                <Icons.Shield size={10}/> Target Logic
                                            </div>
                                            <div className="leading-relaxed opacity-90">{targetLogic || "No target logic has been added yet for this KPI."}</div>
                                        </div>
                                    )}
                                </div>
                            </div>

                            {/* Description / Meaning Section */}
                            {kpi?.description && (
                                <div className="bg-indigo-50/50 rounded-xl border border-indigo-100 p-4">
                                    <div className="text-xs font-bold text-indigo-900 uppercase tracking-wide mb-2 flex items-center gap-2">
                                        <Icons.FileText size={14} /> Meaning & Significance
                                    </div>
                                    <div className="text-sm text-slate-700 leading-relaxed">
                                        {kpi.description}
                                    </div>
                                </div>
                            )}

                            {/* Strategic Relations List */}
                            <div>
                                <div className="text-xs font-bold text-slate-500 uppercase tracking-wide mb-3 flex items-center gap-2">
                                    <Icons.Link size={14} /> Strategic Relations & Impact
                                </div>
                                {rel.length ? (
                                    <div className="space-y-2">
                                        {rel.map((d) => (
                                            <div key={d} className="flex items-start gap-3 p-2.5 rounded-lg bg-slate-50 border border-slate-100 hover:border-slate-300 transition-colors">
                                                <span className={`dept-badge small shrink-0 dept-${deptToClass(d)}`}>{d}</span>
                                                <div className="text-xs text-slate-600 leading-snug pt-0.5">
                                                    {getRelationText(d)}
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                ) : (
                                    <div className="text-sm text-slate-500 italic px-2">No direct inter-departmental dependencies listed.</div>
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };
        
        const DeptModal = ({ isOpen, onClose, data, onKpiSelect, onKpiHover, onKpiLeave }) => {
            if (!isOpen || !data) return null;
            const Icon = data.icon || Icons.Building2;
            const rel = Array.from(new Set((data.kpis || []).flatMap(k => (k.relatedDepts || [])))).filter(Boolean);

            return (
                <div className="fixed inset-0 bg-slate-900/55 z-[55] flex items-center justify-center p-4 backdrop-blur-sm" onClick={onClose}>
                    <div className="bg-white rounded-2xl shadow-2xl w-full max-w-3xl dept-pop border border-slate-200 overflow-hidden flex flex-col max-h-[90vh]" onClick={(e) => e.stopPropagation()}>
                        <div className={`p-5 border-b border-slate-100 flex items-start justify-between ${data.colorClass || "bg-slate-800"} text-white shrink-0`}>
                            <div className="min-w-0 pr-4">
                                <div className="text-[11px] text-white/80 font-semibold uppercase tracking-wide">Focused Department Table</div>
                                <div className="flex items-center gap-2 mt-1">
                                    <div className="p-2 bg-white/15 rounded-lg backdrop-blur-sm">
                                        <Icon size={18} />
                                    </div>
                                    <div className="text-lg font-bold leading-snug">{data.title}</div>
                                </div>
                                <div className="text-xs text-white/80 mt-1">{data.roleFocus}</div>
                            </div>
                            <button onClick={onClose} className="p-2 hover:bg-white/15 rounded-full transition-colors" title="Close">
                                <Icons.X size={18} />
                            </button>
                        </div>

                        <div className="overflow-y-auto custom-scrollbar flex-grow p-4 bg-slate-50">
                            
                            {/* --- STRATEGIC BRIEF SECTION --- */}
                            {data.brief && (
                                <div className="mb-6 bg-white p-4 rounded-xl border border-slate-200 shadow-sm">
                                    <div className="flex items-center gap-2 mb-3 pb-2 border-b border-slate-100">
                                        <div className="p-1.5 bg-indigo-100 text-indigo-700 rounded-md">
                                            <Icons.FileText size={16} weight="bold"/>
                                        </div>
                                        <h4 className="text-sm font-bold text-slate-800">Strategic Brief</h4>
                                    </div>
                                    
                                    <div className="grid md:grid-cols-2 gap-4">
                                        <div>
                                            <div className="text-[11px] uppercase tracking-wide font-bold text-slate-400 mb-1">What it means</div>
                                            <p className="text-xs leading-relaxed text-slate-600">{data.brief.description}</p>
                                        </div>
                                        <div>
                                            <div className="text-[11px] uppercase tracking-wide font-bold text-slate-400 mb-1">Inter-Departmental Impact</div>
                                            <p className="text-xs leading-relaxed text-slate-600">{data.brief.relation}</p>
                                        </div>
                                    </div>
                                </div>
                            )}

                            <div className="text-xs font-semibold text-slate-600 mb-2">KPIs</div>
                            <div className="space-y-1">
                                {(data.kpis || []).map((kpi, idx) => (
                                    <KPICard 
                                        key={idx} 
                                        {...kpi} 
                                        onSelect={(picked) => { onClose(); onKpiSelect && onKpiSelect(picked); }}
                                        onHover={onKpiHover} 
                                        onLeave={onKpiLeave} 
                                    />
                                ))}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };


    const App = () => {
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [isSettingsOpen, setIsSettingsOpen] = useState(false);
            const [modalTitle, setModalTitle] = useState('');
            const [modalContent, setModalContent] = useState('');
            const [modalError, setModalError] = useState(null);
            const [isLoading, setIsLoading] = useState(false);
            const [hoveredNode, setHoveredNode] = useState(null);
            const [kpiModal, setKpiModal] = useState(null); // { kpi, origin }
            const [deptModal, setDeptModal] = useState(null); // { id, title, roleFocus, colorClass, icon, kpis }
            const [highlightDepts, setHighlightDepts] = useState([]);
            
            // Transform State for Pan & Zoom
            const [transform, setTransform] = useState({ x: 0, y: 0, scale: 1 });
            const containerRef = useRef(null);
            const isDragging = useRef(false);
            const lastMouse = useRef({ x: 0, y: 0 });

            // Initialize and Center View
            const centerView = () => {
                const baseWidth = 2600; 
                const baseHeight = 1300; 
                const padding = 40; 
                const wrapper = containerRef.current;
                
                if (!wrapper) return;
                
                const availableWidth = wrapper.clientWidth - padding;
                const availableHeight = wrapper.clientHeight - padding;
                
                const scaleX = availableWidth / baseWidth;
                const scaleY = availableHeight / baseHeight;
                const newScale = Math.min(1, scaleX, scaleY); 
                
                const x = (wrapper.clientWidth - baseWidth * newScale) / 2;
                const y = (wrapper.clientHeight - baseHeight * newScale) / 2;
                
                setTransform({ x, y, scale: newScale });
            };

            useEffect(() => {
                centerView();
                window.addEventListener('resize', centerView);
                return () => window.removeEventListener('resize', centerView);
            }, []);

            const handleWheel = (e) => {
                if (isModalOpen || deptModal || kpiModal) return; 
                e.preventDefault();
                const ZOOM_SPEED = 0.001;
                const newScale = Math.min(Math.max(0.1, transform.scale - e.deltaY * ZOOM_SPEED * transform.scale), 5); 
                const rect = containerRef.current.getBoundingClientRect();
                const mouseX = e.clientX - rect.left;
                const mouseY = e.clientY - rect.top;
                const worldX = (mouseX - transform.x) / transform.scale;
                const worldY = (mouseY - transform.y) / transform.scale;
                const newX = mouseX - worldX * newScale;
                const newY = mouseY - worldY * newScale;
                setTransform({ x: newX, y: newY, scale: newScale });
            };

            const handleMouseDown = (e) => {
                if (e.target.closest('button') || e.target.closest('[role="button"]')) return;
                isDragging.current = true;
                lastMouse.current = { x: e.clientX, y: e.clientY };
                document.body.style.cursor = 'grabbing';
            };

            const handleMouseMove = (e) => {
                if (!isDragging.current) return;
                e.preventDefault();
                const dx = e.clientX - lastMouse.current.x;
                const dy = e.clientY - lastMouse.current.y;
                lastMouse.current = { x: e.clientX, y: e.clientY };
                setTransform(prev => ({ ...prev, x: prev.x + dx, y: prev.y + dy }));
            };

            const handleMouseUp = () => {
                isDragging.current = false;
                document.body.style.cursor = 'default';
            };

            const [apiKey, setApiKey] = useState(() => localStorage.getItem('gemini_api_key') || "");

            const handleSaveKey = (key) => {
                setApiKey(key);
                localStorage.setItem('gemini_api_key', key);
                if (modalTitle) setIsModalOpen(false); 
            };

            const handleKpiSelect = (originTitle) => (kpi) => {
                setKpiModal({ kpi, origin: originTitle });
                setHighlightDepts((kpi && kpi.relatedDepts) ? kpi.relatedDepts : []);
            };
            const handleKpiHover = (rel) => {
                if (kpiModal) return;
                setHighlightDepts(rel || []);
            };
            const handleKpiLeave = () => {
                if (kpiModal) return;
                setHighlightDepts([]);
            };
            const closeKpiModal = () => {
                setKpiModal(null);
                setHighlightDepts([]);
            };

            const handleDeptSelect = (dept) => {
                setDeptModal(dept);
                const rel = Array.from(new Set((dept?.kpis || []).flatMap(k => (k.relatedDepts || [])))).filter(Boolean);
                setHighlightDepts(rel);
            };
            const closeDeptModal = () => {
                setDeptModal(null);
                if (!kpiModal) setHighlightDepts([]);
            };

// --- DATA STRUCTURES (Updated from PDF) ---
            const ceoData = {
                id: 'CEO',
                title: "CEO (Chief Executive Officer)",
                roleFocus: "Strategy, Growth, Major Clients, Risk Ownership",
                icon: Icons.Briefcase,
                color: "bg-slate-800",
                brief: {
                    description: "Responsible for sustainable revenue growth, stability of the client base (retention), and securing major strategic partnerships (ADNOC/Tier-1). Owns the ultimate risk for safety and reputation.",
                    relation: "Sets the strategic direction which Commercial executes, Operations delivers, and Finance monitors. Directs major client engagement and risk tolerance."
                },
                kpis: [
                    { 
                        title: "Revenue Growth", 
                        type: "Financial", 
                        target: "+15% YoY", 
                        targetExplanation: "Ensures sustainable growth without overstretching assets or people. Too low = stagnation, too high = uncontrolled risk.",
                        relatedDepts: ['Commercial','Finance'], 
                        owner: "CEO",
                        description: "Sustainable growth measured as (Current Y revenue - Last Y) / Last Y. A drop warns that clients may be stopping tenders or delaying awards.",
                        relationDetails: {
                            "Commercial": "Must secure higher value contracts.",
                            "Finance": "Records and validates revenue recognition."
                        }
                    },
                    { 
                        title: "Client Retention", 
                        type: "Growth", 
                        target: "≥ 80%", 
                        targetExplanation: "In marine/diving, repeat clients mean trust. Losing repeat work is an early sign of quality or relationship failure.",
                        relatedDepts: ['Commercial','Operations'], 
                        owner: "CEO",
                        description: "Measures stable client base (Repeat clients / Total clients). A drop is a silent warning that clients are not prioritizing us, potentially due to poor execution or relationship management.",
                        relationDetails: {
                            "Commercial": "Maintains relationship health.",
                            "Operations": "Delivers quality that brings clients back."
                        }
                    },
                    { 
                        title: "Major Client Approval", 
                        type: "Strategic", 
                        target: "1–2 / yr", 
                        targetExplanation: "Access to ADNOC / Tier-1 clients is strategic, not volume-based. Even one approval changes company positioning.",
                        relatedDepts: ['Commercial'], 
                        owner: "CEO",
                        description: "Count of approved access to Tier-1 clients (e.g., ADNOC). Critical for long-term revenue eligibility.",
                        relationDetails: {
                            "Commercial": "Prepares pre-qualification submissions."
                        }
                    },
                    { 
                        title: "Zero Major Incidents", 
                        type: "Safety", 
                        target: "ZERO", 
                        targetExplanation: "One fatal or major incident can shut down operations, damage reputation, and block future contracts.",
                        relatedDepts: ['QHSE','Operations','Diving','Plant'], 
                        owner: "CEO",
                        description: "Protects life and reputation. Measured by fatalities or major incidents. Safety failures directly damage client trust and market eligibility.",
                         relationDetails: {
                            "QHSE": "Manages safety systems.",
                            "Operations": "Executes safely.",
                            "Diving": "Manages high-risk underwater activities."
                        }
                    },
                    { 
                        title: "Cash Stability", 
                        type: "Financial", 
                        target: "Positive", 
                        targetExplanation: "Survival KPI. Even profitable companies fail if cash is negative.",
                        relatedDepts: ['Finance','Commercial'], 
                        owner: "CEO",
                        description: "Ensures survival and resilience. Calculated as Bank + Receivables - Payables. If negative, the company cannot sustain operations.",
                        relationDetails: {
                            "Finance": "Manages cash flow reporting.",
                            "Commercial": "Accelerates collections."
                        }
                    },
                    { 
                        title: "International Industry Participation", 
                        type: "Strategic", 
                        target: "≥ 2 / yr", 
                        targetExplanation: "Ensures visibility, credibility, and future market access beyond local dependency.",
                        relatedDepts: ['Commercial'], 
                        owner: "CEO",
                        description: "Attendance at global events to strengthen PMS visibility.",
                        relationDetails: { "Commercial": "Uses visibility to open new markets." }
                    },
                    { 
                        title: "Strategic International Partnerships", 
                        type: "Strategic", 
                        target: "≥ 1 / yr", 
                        targetExplanation: "Ensures visibility, credibility, and future market access beyond local dependency.",
                        relatedDepts: ['Commercial'], 
                        owner: "CEO",
                        description: "Signed MOUs or alliances to expand reach.",
                        relationDetails: { "Commercial": "Negotiates partnership terms." }
                    },
                    { 
                        title: "Thought Leadership", 
                        type: "Strategic", 
                        target: "≥ 2 / yr", 
                        targetExplanation: "Builds credibility and sector authority.",
                        relatedDepts: ['Commercial'], 
                        owner: "CEO",
                        description: "Contribution via papers, panels, or keynote roles.",
                        relationDetails: { "Commercial": "Leverages reputation for bids." }
                    }
                ],
                affectedBy: ['COO', 'Commercial', 'Operations', 'Finance', 'QHSE', 'IT', 'Plant', 'HR', 'Diving']
            };

            const cooData = {
                id: 'COO',
                title: "COO (Chief Operating Officer)",
                roleFocus: "Delivery, Cost, Schedule, Safety (Profit Protector)",
                icon: Icons.Activity,
                color: "bg-emerald-700",
                brief: {
                    description: "Acts as the 'Profit Protector' and delivery engine. Ensures projects are delivered on time, within budget (margin protection), and with zero harm. Balances operational speed with safety and quality.",
                    relation: "Orchestrates the execution units (Operations, Diving, Plant) and support functions (HR, QHSE, IT) to minimize margin erosion and operational risk."
                },
                kpis: [
                    { 
                        title: "On-Time Project Delivery", 
                        type: "Operational", 
                        target: "≥ 90%", 
                        targetExplanation: "Some delay is realistic offshore, but <90% indicates planning or control failure.",
                        relatedDepts: ['Operations'], 
                        owner: "COO",
                        description: "Meeting commitments. Measured as Projects on time / Total projects. Delays destroy margin and reputation.",
                         relationDetails: { "Operations": "Executes schedule." }
                    },
                    { 
                        title: "Project Margin Protection", 
                        type: "Financial", 
                        target: "≥ Planned", 
                        targetExplanation: "Winning projects is useless if margin erodes during execution. COO protects profit.",
                        relatedDepts: ['Operations','Finance','Commercial'], 
                        owner: "COO",
                        description: "Preventing profit erosion. Measured by comparing Actual Margin vs. Planned Margin.",
                        relationDetails: {
                            "Operations": "Controls site costs.",
                            "Finance": "Tracks actuals vs budget."
                        }
                    },
                     { 
                        title: "Equipment Readiness", 
                        type: "Asset", 
                        target: "≥ 95%", 
                        targetExplanation: "One missing asset can stop the job. 100% is ideal, 95% is realistic with backups.",
                        relatedDepts: ['Plant','Operations'], 
                        owner: "COO",
                        description: "Avoiding delays caused by asset failure. Measured as Ready assets / Required assets.",
                        relationDetails: { "Plant": "Ensures uptime.", "Operations": "Uses equipment correctly." }
                    },
                    { 
                        title: "Offshore Incidents", 
                        type: "Safety", 
                        target: "ZERO", 
                        targetExplanation: "COO owns day-to-day safety execution, not just policy.",
                        relatedDepts: ['QHSE','Operations','Diving','Plant','HR'], 
                        owner: "COO",
                        description: "Any incident indicates a failure in operational control or safety culture.",
                        relationDetails: { "QHSE": "Safety oversight.", "Operations": "Safe execution." }
                    },
                    { 
                        title: "Client Complaints", 
                        type: "Growth", 
                        target: "ZERO", 
                        targetExplanation: "Complaints are early warnings of future claims or lost clients.",
                        relatedDepts: ['Operations','Commercial'], 
                        owner: "COO",
                        description: "Ensuring quality delivery.",
                        relationDetails: { "Operations": "Quality control.", "Commercial": "Client interface." }
                    },
                    { 
                        title: "Digital Asset & Certification Visibility", 
                        type: "Asset", 
                        target: "100%", 
                        targetExplanation: "No visibility = no control. Missing one certificate can stop an entire project.",
                        relatedDepts: ['Plant','IT'], 
                        owner: "COO", 
                        functions: "NAMS / CMMS / Register",
                        description: "Control of all equipment and certification status.",
                        relationDetails: { "Plant": "Data entry.", "IT": "System uptime." }
                    },
                    { 
                        title: "Technology Deployment", 
                        type: "Technology", 
                        target: "≥ 2 / yr", 
                        targetExplanation: "Prevents stagnation and reduces manual, error-prone processes.",
                        relatedDepts: ['IT','Plant','Operations'], 
                        owner: "COO",
                        description: "Implementation of initiatives that reduce manual work and increase reliability.",
                        relationDetails: { "IT": "Implementation.", "Operations": "Adoption." }
                    },
                    { 
                        title: "Process Optimization Initiatives", 
                        type: "Operational", 
                        target: "≥ 3 / yr", 
                        targetExplanation: "Prevents stagnation and reduces manual, error-prone processes.",
                        relatedDepts: ['Operations','IT'], 
                        owner: "COO",
                        description: "Approved and implemented SOP improvements.",
                        relationDetails: { "Operations": "Process owners.", "IT": "Automation support." }
                    }
                ],
                affectedBy: ['Operations', 'Diving', 'Plant', 'HR', 'QHSE', 'Finance', 'IT']
            };

            const financeData = {
                id: 'Finance',
                title: "Finance Dept",
                roleFocus: "Cash, Collection, Cost Control, Audit",
                icon: Icons.DollarSign,
                color: "bg-blue-600",
                brief: {
                    description: "Protects company survival and liquidity. Focuses on ensuring money in (Cash Flow/DSO) exceeds money out, and that spending stays within budget (Cost Control). Ensures audit readiness at all times.",
                    relation: "Depends on Commercial for collections/invoicing, Operations for billing milestones, and HR for payroll accuracy. Controls spending for all departments."
                },
                kpis: [
                    { 
                        title: "Cash Flow", 
                        type: "Financial", 
                        target: "Positive", 
                        targetExplanation: "Cash pays salaries, fuel, suppliers—profit alone does not.",
                        relatedDepts: ['Commercial','Operations'], 
                        owner: "Finance",
                        description: "Money coming in vs. money going out. Even a profitable company can fail if it has no cash to pay salaries, suppliers, or fuel.",
                        relationDetails: {
                            "Commercial": "Ensures invoices are paid.",
                            "Operations": "Achieves billing milestones."
                        }
                    },
                    { 
                        title: "DSO (Days Sales Outstanding)", 
                        type: "Financial", 
                        target: "< 60 days", 
                        targetExplanation: "Late payments increase financial risk and operational pressure.",
                        relatedDepts: ['Commercial','Operations','CEO'], 
                        owner: "Finance",
                        description: "How many days clients take to pay. The longer the client delays payment, the higher the financial risk and cash pressure.",
                        relationDetails: {
                            "Commercial": "Chases payments.",
                            "Operations": "Resolves technical disputes blocking payment."
                        }
                    },
                    { 
                        title: "Cost Control", 
                        type: "Financial", 
                        target: "≤ 5% var", 
                        targetExplanation: "Small overruns are normal; large ones silently destroy profit.",
                        relatedDepts: ['Operations','Plant','Commercial'], 
                        owner: "Finance",
                        description: "Making sure actual spending stays close to the approved budget. Uncontrolled costs (delays, rework, idle time) quietly destroy profit.",
                         relationDetails: {
                            "Operations": "Controls labor/material use.",
                            "Plant": "Controls repair costs."
                        }
                    },
                    { 
                        title: "Payroll Timeliness", 
                        type: "HR", 
                        target: "100% on time", 
                        targetExplanation: "Late salaries cause morale loss and operational instability.",
                        relatedDepts: ['HR','CEO'], 
                        owner: "Finance",
                        description: "Paying salaries on time, every time.",
                        relationDetails: { "HR": "Payroll processing.", "CEO": "Cash priority decisions." }
                    },
                    { 
                        title: "Audit Readiness", 
                        type: "Governance", 
                        target: "100% clean", 
                        targetExplanation: "Audit failure damages trust, certifications, and client confidence.",
                        relatedDepts: ['All Depts','QHSE','Operations'], 
                        owner: "Finance",
                        description: "Being ready at any time for Financial, ISO, or Client audits.",
                        relationDetails: { "All Depts": "Document discipline.", "QHSE": "ISO compliance." }
                    }
                ],
                affectedBy: ['Commercial', 'Operations', 'Plant', 'HR', 'QHSE']
            };

            const hrData = {
                id: 'HR',
                title: "Administration & HR",
                roleFocus: "Competence, Availability, Culture",
                icon: Icons.UserCheck,
                color: "bg-purple-600",
                brief: {
                    description: "Protects people stability, competence, and discipline. Ensures the right people are hired, trained, certified, and available when projects start. Monitors discipline to prevent safety and culture issues.",
                    relation: "Directly impacts Operations and Diving readiness (crew availability) and Safety (competence/training). Delays in HR lead to mobilization delays."
                },
                kpis: [
                    { 
                        title: "Staff Turnover", 
                        type: "HR", 
                        target: "< 10%", 
                        targetExplanation: "High turnover causes loss of competence and project delays.",
                        relatedDepts: ['Operations','Finance','QHSE','Diving','CEO','COO'], 
                        owner: "HR",
                        description: "Employees leaving the company. High turnover causes loss of experience, delays, and extra recruitment costs.",
                        relationDetails: {
                            "Operations": "Site conditions affect retention.",
                            "Finance": "Salary timeliness affects retention."
                        }
                    },
                    { 
                        title: "Certification Validity (People)", 
                        type: "Safety", 
                        target: "100%", 
                        targetExplanation: "Expired certificates can stop work and fail audits instantly.",
                        relatedDepts: ['Operations','QHSE','Commercial','Diving'], 
                        owner: "HR",
                        description: "Ensuring all employee certificates (safety, medical, licenses) are valid. Expired certificates can stop work and fail audits.",
                        relationDetails: {
                            "Operations": "Cannot mobilize uncertified crew.",
                            "QHSE": "Audits compliance."
                        }
                    },
                    { 
                        title: "Crew Availability", 
                        type: "Operational", 
                        target: "≥ 95%", 
                        targetExplanation: "Lack of crew delays mobilization and breaks commitments.",
                        relatedDepts: ['Operations','Commercial','Finance','QHSE','Diving'], 
                        owner: "HR",
                        description: "Having enough trained staff ready when projects start.",
                        relationDetails: { "Operations": "Project execution.", "Commercial": "Tender commitments." }
                    },
                    { 
                        title: "Training Completion", 
                        type: "HR", 
                        target: "≥ 90%", 
                        targetExplanation: "Training improves safety, quality, and long-term capability.",
                        relatedDepts: ['Operations','QHSE','Diving','CEO','COO'], 
                        owner: "HR",
                        description: "Completion of required training by employees.",
                        relationDetails: { "Operations": "On-site performance.", "QHSE": "Safety competence." }
                    },
                    { 
                        title: "Discipline Issues", 
                        type: "Governance", 
                        target: "ZERO major", 
                        targetExplanation: "Poor discipline leads to accidents and reputation damage.",
                        relatedDepts: ['Operations','QHSE','Diving','CEO','COO'], 
                        owner: "HR",
                        description: "Major behavior or conduct violations.",
                        relationDetails: { "Operations": "Site discipline.", "QHSE": "Safety violations." }
                    }
                ],
                affectedBy: ['Operations', 'Finance', 'QHSE', 'Diving', 'Commercial']
            };

            const opsData = {
                id: 'Operations',
                title: "Operations Dept",
                roleFocus: "Project Execution",
                icon: Icons.Layers,
                color: "bg-cyan-600",
                brief: {
                    description: "Execution excellence. Responsible for starting on time (Mobilization Readiness), working efficiently (Daily Plan Achievement), and minimizing self-inflicted delays. It is the engine of the company.",
                    relation: "Success depends on Plant (equipment), HR (crew), Diving (specialist scope), QHSE (compliance), and Finance (budget control). Operations integrates these inputs to deliver value."
                },
                kpis: [
                    { 
                        title: "Mobilization Readiness", 
                        type: "Operational", 
                        target: "100%", 
                        targetExplanation: "Any missing document, crew, or asset on Day 1 causes immediate delay and cost.",
                        relatedDepts: ['Plant','HR','Diving','QHSE','IT'], 
                        owner: "Operations",
                        description: "Ability to start the project on the planned date with all people, equipment, approvals, and logistics fully ready. Any gap creates immediate delay and extra cost.",
                        relationDetails: {
                            "Plant": "Equipment availability & certification",
                            "HR": "Crew availability, visas, certifications",
                            "Diving": "Dive team readiness (if applicable)",
                            "QHSE": "Approved methods, risk assessments",
                            "IT": "Systems, reporting, digital readiness"
                        }
                    },
                    { 
                        title: "Daily Plan Achievement", 
                        type: "Operational", 
                        target: "≥ 85%", 
                        targetExplanation: "Offshore work is dynamic; 100% is unrealistic. Below 85% shows weak planning or discipline.",
                        relatedDepts: ['Plant','HR','Diving','QHSE','IT'], 
                        owner: "Operations",
                        description: "Degree to which the Operations team delivers what was planned for the day. Shows execution discipline and planning quality.",
                        relationDetails: {
                            "Plant": "Asset uptime prevents stoppages.",
                            "HR": "Manpower attendance.",
                            "Diving": "Operational execution of marine scopes.",
                            "QHSE": "Uninterrupted work through compliance."
                        }
                    },
                    { 
                        title: "PMS-Caused Delays", 
                        type: "Operational", 
                        target: "ZERO", 
                        targetExplanation: "Internal delays are fully controllable and directly reduce profit.",
                        relatedDepts: ['Plant','HR','Diving','QHSE','IT'], 
                        owner: "Operations",
                        description: "Delays caused internally by PMS (e.g., late mob, wrong equipment, missing docs). These are fully controllable and directly reduce margin.",
                        relationDetails: {
                             "Plant": "Equipment readiness failures.",
                             "HR": "Crew unavailability.",
                             "QHSE": "Late approvals."
                        }
                    },
                    { 
                        title: "Cost Variance", 
                        type: "Financial", 
                        target: "≤ 5%", 
                        targetExplanation: "Small variance is acceptable; above this signals loss of control.",
                        relatedDepts: ['Finance','Plant'], 
                        owner: "Operations",
                        description: "Difference between planned project cost and actual cost.",
                        relationDetails: { "Finance": "Budget tracking.", "Plant": "Equipment efficiency." }
                    },
                    { 
                        title: "Major NCRs", 
                        type: "Operational", 
                        target: "ZERO", 
                        targetExplanation: "Major non-conformances can stop work and damage client trust.",
                        relatedDepts: ['QHSE','Diving','Plant'], 
                        owner: "Operations",
                        description: "Serious breaches of quality, safety, or compliance requirements.",
                        relationDetails: { "QHSE": "Audits.", "Diving": "Standards compliance." }
                    }
                ],
                affectedBy: ['Plant', 'HR', 'Diving', 'QHSE', 'IT', 'Finance']
            };

            const divingData = {
                id: 'Diving', 
                title: "Diving Dept (IMCA)", 
                roleFocus: "Core Business & Life-Critical Safety",
                icon: Icons.Anchor,
                color: "bg-teal-600",
                brief: {
                    description: "Manages the core business activity with high risk. Aligned with IMCA D014/D018 standards to ensure incident-free dive hours, strict dive plan compliance, and zero rework.",
                    relation: "Relies heavily on Plant for safe equipment, HR for competent divers, and QHSE for safety verification to execute Operations' schedules safely."
                },
                kpis: [
                    { 
                        title: "Incident-Free Dive Hours", 
                        type: "Safety", 
                        target: "100%", 
                        targetExplanation: "Diving has zero tolerance for accidents; one failure can be fatal.",
                        relatedDepts: ['QHSE','Plant','Operations'], 
                        owner: "Diving",
                        description: "Diving hours completed without accidents or incidents. Any incident during diving work can cause serious injury, fatality, or project stoppage.",
                         relationDetails: {
                            "Plant": "Maintains life-support equipment.",
                            "QHSE": "Verifies safety procedures.",
                            "Operations": "Coordinates schedule."
                        }
                    },
                    { 
                        title: "Dive Plan Compliance", 
                        type: "Operational", 
                        target: "≥ 95%", 
                        targetExplanation: "Minor justified deviations happen, but frequent deviations mean loss of control.",
                        relatedDepts: ['QHSE','Operations','Management'], 
                        owner: "Diving",
                        description: "Executing dives exactly according to the approved dive plan. Deviating increases risk and shows loss of operational control.",
                        relationDetails: { "QHSE": "Audits compliance.", "Operations": "Follows the plan." }
                    },
                    { 
                        title: "Equipment Condition (Diving)", 
                        type: "Asset", 
                        target: "100%", 
                        targetExplanation: "Equipment failure underwater is life-critical.",
                        relatedDepts: ['Plant','QHSE'], 
                        owner: "Diving",
                        description: "All diving equipment is safe, functional, and fit for use. Faulty or poorly maintained equipment can directly cause diving incidents.",
                        relationDetails: { "Plant": "Maintains equipment.", "QHSE": " inspects for safety." }
                    },
                    { 
                        title: "CMS Compliance", 
                        type: "HR", 
                        target: "100%", 
                        targetExplanation: "Uncertified divers = illegal, unsafe, and non-compliant with IMCA.",
                        relatedDepts: ['HR','QHSE'], 
                        owner: "Diving",
                        description: "Competence Management System: All divers are trained, certified, and medically fit.",
                        relationDetails: { "HR": "Certification records.", "QHSE": "Compliance verification." }
                    },
                    { 
                        title: "Rework / NCRs", 
                        type: "Operational", 
                        target: "ZERO", 
                        targetExplanation: "Rework in diving means poor planning or unsafe execution.",
                        relatedDepts: ['QHSE','Operations'], 
                        owner: "Diving",
                        description: "Work that had to be corrected or repeated.",
                        relationDetails: { "QHSE": "Investigation.", "Operations": "Planning." }
                    }
                ],
                affectedBy: ['Plant', 'HR', 'QHSE', 'Operations']
            };

            const plantData = {
                id: 'Plant',
                title: "Plant / Assets",
                roleFocus: "Readiness, Certification, Reliability",
                icon: Icons.HardHat,
                color: "bg-orange-600",
                brief: {
                    description: "Ensures Equipment Readiness to prevent work stoppages. Critical equipment must be 100% ready or have backups. Focuses on certification validity and minimizing breakdown incidents.",
                    relation: "Enables Operations to work (uptime), Commercial to bid (capability), and Diving to operate safely. Failures here cause immediate extra costs for Finance (rentals/repairs)."
                },
                kpis: [
                    { 
                        title: "Equipment Availability", 
                        type: "Asset", 
                        target: "≥ 95%", 
                        targetExplanation: "One missing critical asset can stop the job entirely.",
                        relatedDepts: ['Operations','Commercial','Finance','Diving'], 
                        owner: "Plant",
                        description: "How much equipment is ready to work when needed. If one critical machine is missing, the job can stop even if many other tools are ready.",
                        relationDetails: {
                            "Operations": "Cannot work without equipment.",
                            "Commercial": "Cannot promise jobs if equipment is unready.",
                            "Finance": "Missing equipment forces expensive rentals.",
                            "Diving": "Stops if critical dive systems missing."
                        }
                    },
                    { 
                        title: "Certification Validity", 
                        type: "Asset", 
                        target: "100%", 
                        targetExplanation: "Uncertified equipment cannot be used, even if functional.",
                        relatedDepts: ['QHSE','Operations','Commercial','Diving'], 
                        owner: "Plant", 
                        functions: "NAMS / Register",
                        description: "All equipment papers and certificates must be valid and not expired. Equipment without valid certificates cannot be used, even if it works.",
                         relationDetails: {
                            "Operations": "Client rejects uncertified tools.",
                            "Commercial": "Tenders fail without certs."
                        }
                    },
                    { 
                        title: "Breakdown Incidents", 
                        type: "Asset", 
                        target: "ZERO", 
                        targetExplanation: "Breakdowns cause delays, safety risks, and extra cost.",
                        relatedDepts: ['Operations','Finance','QHSE','Diving'], 
                        owner: "Plant",
                        description: "Equipment stopping suddenly because of failure.",
                        relationDetails: { "Operations": "Work stops.", "Finance": "Repair costs." }
                    },
                    { 
                        title: "Damage Rate", 
                        type: "Financial", 
                        target: "< 2%", 
                        targetExplanation: "Damage shortens asset life and increases cost.",
                        relatedDepts: ['Operations','HR','QHSE','Finance'], 
                        owner: "Plant",
                        description: "Equipment damaged because of misuse, bad handling, or accidents.",
                        relationDetails: { "Operations": "Misuse during work.", "HR": "Training gap." }
                    },
                    { 
                        title: "Utilization Rate", 
                        type: "Financial", 
                        target: "≥ 70%", 
                        targetExplanation: "Too low = wasted capital, too high = accelerated failure.",
                        relatedDepts: ['Commercial','Operations','Finance'], 
                        owner: "Plant",
                        description: "How much equipment is actually used compared to what is available.",
                        relationDetails: { "Commercial": "Plans work load.", "Operations": "Schedules use." }
                    },
                    { 
                        title: "Preventive Maintenance Digitalization", 
                        type: "Technology", 
                        target: "≥ 80%", 
                        targetExplanation: "Planned maintenance is cheaper and safer than breakdown repair.",
                        relatedDepts: ['IT','Operations','QHSE'], 
                        owner: "Plant",
                        description: "Fixing and servicing equipment before it breaks. Reduces operational risk through automated maintenance systems.",
                        relationDetails: { "IT": "System support.", "Operations": "Equipment reliability." }
                    }
                ],
                affectedBy: ['Finance', 'IT', 'Operations', 'Commercial', 'QHSE', 'HR', 'Diving']
            };

            const commercialData = {
                id: 'Commercial',
                title: "Commercial Dept",
                roleFocus: "Tenders, Pricing, Backlog, Growth",
                icon: Icons.FileText,
                color: "bg-indigo-600",
                brief: {
                    description: "Drives growth and revenue. Focuses on understanding client behavior to win the *right* tenders, pricing accurately to protect margin, and securing a 6-month backlog to stabilize the company.",
                    relation: "Feeds the pipeline for Operations. Depends on Operations/Plant for capability data and Finance for pricing limits. Must align tender compliance with QHSE standards."
                },
                kpis: [
                    { 
                        title: "Tender Win Rate", 
                        type: "Growth", 
                        target: "≥ 30%", 
                        targetExplanation: "Below this means poor bid selection or pricing; higher can mean underpricing.",
                        relatedDepts: ['Operations','Finance','CEO'], 
                        owner: "Commercial",
                        description: "Percentage of tenders won out of tenders submitted. Shows how well Commercial selects the right tenders and prices them competitively.",
                        relationDetails: {
                            "Operations": "Confirms capability to execute.",
                            "Finance": "Approves pricing margins."
                        }
                    },
                    { 
                        title: "Tender Compliance", 
                        type: "Governance", 
                        target: "100%", 
                        targetExplanation: "One missing document = automatic rejection.",
                        relatedDepts: ['Operations','QHSE','IT'], 
                        owner: "Commercial",
                        description: "Submitting tenders fully aligned with client requirements (zero errors). Non-compliant tenders are rejected regardless of price or experience.",
                        relationDetails: { "Operations": "Technical scope.", "QHSE": "Safety compliance." }
                    },
                    { 
                        title: "Backlog Coverage", 
                        type: "Strategic", 
                        target: "≥ 6 months", 
                        targetExplanation: "Ensures stable workload and avoids panic bidding or idle assets.",
                        relatedDepts: ['Operations','Finance','CEO'], 
                        owner: "Commercial",
                        description: "Amount of confirmed future work secured. Ensures stable workload and avoids idle resources or rushed bidding.",
                        relationDetails: { "Operations": "Resource planning.", "Finance": "Cash flow projection." }
                    },
                    { 
                        title: "Pricing Accuracy", 
                        type: "Financial", 
                        target: "≥ 95%", 
                        targetExplanation: "Winning with wrong pricing destroys margin after award.",
                        relatedDepts: ['Operations','Plant','Finance'], 
                        owner: "Commercial",
                        description: "How close the tender price is to the real execution cost.",
                        relationDetails: { "Operations": "Execution cost.", "Plant": "Asset cost." }
                    },
                    { 
                        title: "Client Follow-up", 
                        type: "Growth", 
                        target: "100% logged", 
                        targetExplanation: "Feedback improves future bids and relationships.",
                        relatedDepts: ['CEO','Operations','IT'], 
                        owner: "Commercial",
                        description: "Tracking client feedback after tender submission.",
                        relationDetails: { "CEO": "Client relationship.", "Operations": "Post-award coordination." }
                    },
                    { 
                        title: "International Market Penetration", 
                        type: "Growth", 
                        target: "> 20%", 
                        targetExplanation: "Reduces dependency on one market and spreads risk.",
                        relatedDepts: ['CEO','Operations','Finance'], 
                        owner: "Commercial",
                        description: "Winning work outside the UAE.",
                        relationDetails: { "CEO": "Strategy.", "Operations": "Capability abroad." }
                    },
                    { 
                        title: "Market Survey", 
                        type: "Strategic", 
                        target: "Active", 
                        targetExplanation: "Understanding client behavior helps price correctly.",
                        relatedDepts: ['Operations','Finance','CEO'], 
                        owner: "Commercial",
                        description: "Understanding the market: upcoming tenders, competitors, prices, and client behavior.",
                        relationDetails: { "CEO": "Strategy input.", "Finance": "Pricing strategy." }
                    }
                ],
                affectedBy: ['Operations', 'Finance', 'CEO', 'QHSE', 'IT', 'Plant']
            };
            
            const qhseData = {
                id: 'QHSE',
                title: "QHSE Dept",
                roleFocus: "ISO Compliance, Safety, Environment",
                icon: Icons.Shield,
                color: "bg-red-600",
                brief: {
                    description: "Protects the company's license to operate. Focuses on Zero Harm (TRIR), preventing incidents via Near Miss reporting, and stopping unsafe work immediately. Ensures ISO/Client audit compliance.",
                    relation: "Enforces standards across Operations, Diving, and Plant. Validates Commercial tenders. Requires HR support for safety training and culture building."
                },
                kpis: [
                    { 
                        title: "TRIR (Total Recordable Injury Rate)", 
                        type: "Safety", 
                        target: "ZERO", 
                        targetExplanation: "Injuries indicate system failure and weak enforcement.",
                        relatedDepts: ['Operations','HR','Plant','Diving','Management'], 
                        owner: "QHSE",
                        description: "Counts how many work injuries are serious enough to be recorded. Shows how safe the workplace is.",
                        relationDetails: {
                            "Operations": "Daily supervision.",
                            "HR": "Safety training.",
                            "Plant": "Safe equipment."
                        }
                    },
                    { 
                        title: "Near Miss Reporting", 
                        type: "Safety", 
                        target: "↑ trend", 
                        targetExplanation: "More reports = better safety awareness, not worse safety.",
                        relatedDepts: ['Operations','Plant','Diving','HR'], 
                        owner: "QHSE",
                        description: "Reporting unsafe situations that almost caused an accident but did not.",
                        relationDetails: { "Operations": "Hazard reporting.", "HR": "Safety culture." }
                    },
                    { 
                        title: "Stop Work Actions", 
                        type: "Safety", 
                        target: "≥ baseline", 
                        targetExplanation: "Stopping unsafe work saves lives; suppression kills.",
                        relatedDepts: ['Operations','Plant','Diving','Management'], 
                        owner: "QHSE",
                        description: "Stopping work immediately when conditions are unsafe.",
                        relationDetails: { "Operations": "Authority on site.", "Management": "Support." }
                    },
                    { 
                        title: "Audit Findings Closed", 
                        type: "Governance", 
                        target: "100% on time", 
                        targetExplanation: "Open findings mean the IMS is ineffective.",
                        relatedDepts: ['All Depts','Operations','Plant','HR'], 
                        owner: "QHSE",
                        description: "Issues found during audits that are corrected and officially closed.",
                        relationDetails: { "All Depts": "Corrective actions.", "Operations": "Compliance." }
                    },
                    { 
                        title: "Environmental Incidents", 
                        type: "Safety", 
                        target: "ZERO", 
                        targetExplanation: "Environmental damage causes fines, stoppages, and reputation loss.",
                        relatedDepts: ['Operations','Plant','Diving','Management'], 
                        owner: "QHSE",
                        description: "Any event that causes harm to the environment (spills, pollution).",
                        relationDetails: { "Operations": "Work practices.", "Plant": "Equipment leaks." }
                    }
                ],
                affectedBy: ['Operations', 'Diving', 'Plant', 'HR', 'Commercial', 'Finance', 'IT']
            };

            const itData = {
                id: 'IT',
                title: "IT / Digital Systems",
                roleFocus: "Systems, Data, Automation, Document Control",
                icon: Icons.Layers,
                color: "bg-sky-600",
                brief: {
                    description: "Focuses on System Uptime and Automation. Ensures critical digital assets (ERP, CRM, NAMS) are available and that manual processes are automated to reduce error and risk.",
                    relation: "Supports Finance (data accuracy), Plant (maintenance automation), and Commercial (CRM) with reliable infrastructure. Essential for data-driven decisions."
                },
                kpis: [
                    { 
                        title: "System Uptime", 
                        type: "Technology", 
                        target: "≥ 99%", 
                        targetExplanation: "System downtime stops Operations and Finance.",
                        relatedDepts: ['All Depts'], 
                        owner: "IT",
                        description: "Ensuring critical digital systems (ERP, CRM, NAMS) are available. Downtime disrupts Operations, Finance, and Plant.",
                        relationDetails: { "All Depts": "Daily work continuity." }
                    },
                    { 
                        title: "Automation Delivery", 
                        type: "Technology", 
                        target: "Monthly", 
                        targetExplanation: "Reduces manual work and increases reliability.",
                        relatedDepts: ['COO','Plant','Operations','Commercial'], 
                        owner: "IT",
                        description: "Delivering planned automation initiatives (e.g., PM auto-triggers).",
                        relationDetails: { "COO": "Strategic goals.", "Plant": "Auto-maintenance." }
                    },
                    { 
                        title: "Data Quality", 
                        type: "Technology", 
                        target: "≥ 95%", 
                        targetExplanation: "Poor data leads to wrong strategic decisions.",
                        relatedDepts: ['Finance','Operations','Commercial','Plant'], 
                        owner: "IT",
                        description: "Accuracy of data in reports (Financial, Operational).",
                        relationDetails: { "Finance": "Report accuracy.", "Operations": "Planning data." }
                    }
                ],
                affectedBy: ['Finance', 'Operations', 'Plant', 'Commercial', 'QHSE', 'HR']
            };


            const callGemini = async (prompt) => {
                if (!apiKey) {
                    setModalError("Missing API Key. Please add your Gemini API Key in Settings to use the AI analysis features.");
                    setIsLoading(false);
                    return;
                }

                setIsLoading(true);
                setModalError(null);
                
                try {
                    const response = await fetch(
                        `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`,
                        {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] }),
                        }
                    );
                    
                    if (!response.ok) {
                        throw new Error(`API Error: ${response.status}`);
                    }

                    const data = await response.json();
                    const text = data.candidates?.[0]?.content?.parts?.[0]?.text;
                    
                    if (text) {
                        // Simple markdown-to-html converter for the response
                        const formattedText = text
                            .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                            .replace(/\n/g, '<br/>');
                        setModalContent(formattedText);
                    } else {
                        setModalContent("No insights generated.");
                    }
                } catch (error) {
                    setModalError("Error connecting to AI service. Check your API key or network connection.");
                    console.error(error);
                } finally {
                    setIsLoading(false);
                }
            };

            const handleAnalyze = (role, kpis, focus) => {
                setIsModalOpen(true);
                setModalTitle(`Analyzing Role: ${role}`);
                setModalContent('');
                setModalError(null);
                
                const prompt = `
                    You are a strategic business consultant for an Offshore Marine Services company.
                    
                    Analyze this role:
                    Role: ${role}
                    Focus: ${focus}
                    Key Performance Indicators (KPIs): ${JSON.stringify(kpis)}

                    Provide a concise, strategic critique in 3 short paragraphs:
                    1. **Hidden Risk:** What is the biggest "blind spot" or risk for this role based on these KPIs?
                    2. **Strategic Move:** Suggest one high-impact cross-departmental action to improve performance.
                    3. **Innovation Opportunity:** How can this role better leverage technology?
                    
                    Keep the tone professional and actionable.
                `;
                callGemini(prompt);
            };

            // Combine all departments into a single ordered list
            const allDepts = [commercialData, financeData, hrData, itData, opsData, plantData, divingData, qhseData];

            return (
                <div className="min-h-screen pb-20 bg-slate-100 font-sans">
                    <DeptModal
                        isOpen={!!deptModal}
                        onClose={closeDeptModal}
                        data={deptModal}
                        onKpiSelect={(kpi) => {
                            const origin = deptModal?.title || "Department";
                            setKpiModal({ kpi, origin });
                            setHighlightDepts((kpi && kpi.relatedDepts) ? kpi.relatedDepts : []);
                        }}
                        onKpiHover={handleKpiHover}
                        onKpiLeave={handleKpiLeave}
                        onDeptSelect={handleDeptSelect}
                    />
                    <KPIModal isOpen={!!kpiModal} onClose={closeKpiModal} data={kpiModal} />
                    <AIModal 
                        isOpen={isModalOpen} 
                        onClose={() => setIsModalOpen(false)} 
                        title={modalTitle} 
                        content={modalContent} 
                        isLoading={isLoading} 
                        error={modalError}
                        onSaveKey={handleSaveKey}
                    />
                    
                    <SettingsModal
                        isOpen={isSettingsOpen}
                        onClose={() => setIsSettingsOpen(false)}
                        currentKey={apiKey}
                        onSave={handleSaveKey}
                    />

                    {/* Top Bar */}
                    <div className="bg-white border-b border-slate-200 px-8 py-4 sticky top-0 z-40 shadow-sm flex justify-between items-center">
                        <div>
                            <h1 className="text-2xl font-extrabold text-slate-900 tracking-tight">PMS Strategic Map</h1>
                            <p className="text-xs text-slate-500 font-medium">Hierarchical Alignment & Inter-Departmental Dependencies</p>
                        </div>
                        <div className="flex items-center gap-4">
                            <div className="hidden md:flex items-center gap-2 text-xs bg-amber-50 text-amber-800 px-3 py-1.5 rounded-full border border-amber-200 animate-pulse">
                                <Icons.Link weight="bold" />
                                <span>Hover nodes to trace dependencies</span>
                            </div>
                            <button 
                                onClick={() => setIsSettingsOpen(true)}
                                className="p-2 hover:bg-slate-100 rounded-full text-slate-600 transition-colors"
                                title="Settings"
                            >
                                <Icons.Gear size={24} />
                            </button>
                        </div>
                    </div>

                    {/* SCALABLE CONTENT CONTAINER - Updated for Cursor Zoom & Pan */}
                    <div 
                        className="w-full bg-slate-100 overflow-hidden relative cursor-grab active:cursor-grabbing" 
                        style={{ height: 'calc(100vh - 80px)' }}
                        onWheel={handleWheel}
                        onMouseDown={handleMouseDown}
                        onMouseMove={handleMouseMove}
                        onMouseUp={handleMouseUp}
                        onMouseLeave={handleMouseUp}
                        ref={containerRef}
                    >
                        <div 
                            style={{ 
                                transform: `translate(${transform.x}px, ${transform.y}px) scale(${transform.scale})`, 
                                transformOrigin: '0 0',
                                width: '2600px', 
                                height: '1300px' 
                            }}
                            className="p-8 pt-8 origin-top-left transition-transform duration-75 ease-out"
                        >
                            
                            {/* --- ORG CHART TREE STRUCTURE --- */}

                            <div className="flex flex-col items-center">
                                {/* ROW 1: CEO */}
                                <OrgNode 
                                    {...ceoData} 
                                    colorClass={ceoData.color} 
                                    width="w-80"
                                    onAnalyze={handleAnalyze} 
                                    onHover={setHoveredNode}
                                    hoveredId={hoveredNode}
                                    highlightDepts={highlightDepts}
                                    onKpiSelect={handleKpiSelect(ceoData.title)}
                                    onKpiHover={handleKpiHover}
                                    onKpiLeave={handleKpiLeave}
                                    onDeptSelect={handleDeptSelect}
                                />
                                
                                {/* Vertical Connector CEO -> COO */}
                                <div className="h-12 w-0.5 bg-slate-300"></div>

                                {/* ROW 2: COO */}
                                <OrgNode 
                                    {...cooData} 
                                    colorClass={cooData.color} 
                                    width="w-80" 
                                    onAnalyze={handleAnalyze} 
                                    onHover={setHoveredNode} 
                                    hoveredId={hoveredNode} 
                                    highlightDepts={highlightDepts} 
                                    onKpiSelect={handleKpiSelect(cooData.title)} 
                                    onKpiHover={handleKpiHover} 
                                    onKpiLeave={handleKpiLeave}
                                    onDeptSelect={handleDeptSelect}
                                />

                                {/* Connector from COO to Depts */}
                                <div className="h-8 w-0.5 bg-slate-300"></div>

                                {/* Main Strategic Row: All Departments in One Line */}
                                <div className="flex justify-center w-full">
                                    <div className="flex justify-center">
                                        {allDepts.map((dept, index) => (
                                            <div key={dept.id} className="relative px-3">
                                                
                                                {/* Top Connecting Line Structure for Tree Effect */}
                                                
                                                {/* 1. Vertical line going UP from node */}
                                                <div className="absolute top-[-20px] left-1/2 w-0.5 h-[20px] -ml-[0.5px] bg-slate-300"></div>
                                                
                                                {/* 2. Horizontal line segment LEFT (except for first item) */}
                                                {index > 0 && (
                                                    <div className="absolute top-[-20px] left-0 w-1/2 h-0.5 bg-slate-300"></div>
                                                )}
                                                
                                                {/* 3. Horizontal line segment RIGHT (except for last item) */}
                                                {index < allDepts.length - 1 && (
                                                    <div className="absolute top-[-20px] right-0 w-1/2 h-0.5 bg-slate-300"></div>
                                                )}

                                                <OrgNode 
                                                    {...dept} 
                                                    colorClass={dept.color} 
                                                    width="w-64" 
                                                    hideKpis={true}
                                                    onAnalyze={handleAnalyze} 
                                                    onHover={setHoveredNode} 
                                                    hoveredId={hoveredNode}
                                                    highlightDepts={highlightDepts}
                                                    onKpiSelect={handleKpiSelect(dept.title)}
                                                    onKpiHover={handleKpiHover}
                                                    onKpiLeave={handleKpiLeave}
                                                    onDeptSelect={handleDeptSelect}
                                                />
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            </div>

                            {/* Legend */}
                            <div className="mt-16 border-t border-slate-200 pt-6 flex flex-wrap justify-center gap-6 text-xs text-slate-500 font-medium">
                                <div className="flex items-center gap-2"><div className="w-3 h-3 bg-slate-800 rounded shadow-sm"></div> Executive</div>
                                <div className="flex items-center gap-2"><div className="w-3 h-3 bg-emerald-700 rounded shadow-sm"></div> Operations Lead</div>
                                <div className="flex items-center gap-2"><div className="w-3 h-3 bg-blue-600 rounded shadow-sm"></div> Support Functions</div>
                                <div className="flex items-center gap-2"><div className="w-3 h-3 bg-cyan-600 rounded shadow-sm"></div> Execution Units</div>
                            </div>

                        </div>
                        
                        {/* Reset View Button */}
                        <div className="absolute bottom-6 right-6 z-40">
                             <button 
                                onClick={centerView}
                                className="bg-white hover:bg-slate-50 text-slate-700 px-3 py-2 rounded-lg shadow-lg border border-slate-200 text-xs font-bold flex items-center gap-2 transition-transform active:scale-95"
                            >
                                <Icons.Activity size={16} /> Reset View
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>